# Base Service Architecture

## üìã T·ªïng quan

**BaseService** l√† class c∆° s·ªü cung c·∫•p c√°c ph∆∞∆°ng th·ª©c CRUD chu·∫©n cho t·∫•t c·∫£ c√°c Service trong h·ªá th·ªëng. Gi√∫p gi·∫£m code tr√πng l·∫∑p v√† d·ªÖ d√†ng b·∫£o tr√¨.

## üéØ L·ª£i √≠ch

- ‚úÖ **Gi·∫£m code tr√πng l·∫∑p**: Kh√¥ng c·∫ßn vi·∫øt l·∫°i logic CRUD cho m·ªói Service
- ‚úÖ **D·ªÖ b·∫£o tr√¨**: S·ª≠a logic ·ªü m·ªôt n∆°i, √°p d·ª•ng cho t·∫•t c·∫£ Service
- ‚úÖ **Chu·∫©n h√≥a response**: Format response th·ªëng nh·∫•t
- ‚úÖ **Validation t·ª± ƒë·ªông**: Validate required fields v√† unique fields
- ‚úÖ **T√≠nh m·ªü r·ªông**: D·ªÖ d√†ng override ho·∫∑c th√™m method m·ªõi
- ‚úÖ **Type-safe**: C√≥ JSDoc ƒë·∫ßy ƒë·ªß

## üöÄ C√°ch s·ª≠ d·ª•ng

### 1. T·∫°o Service m·ªõi k·∫ø th·ª´a BaseService

```javascript
const BaseService = require("./base.service");
const db = require("../models");
const YourModel = db.YourModel;

class YourService extends BaseService {
  constructor() {
    super(YourModel, {
      entityName: "your_entity", // T√™n entity (d√πng trong message)
      searchFields: ["name", "code"], // C√°c tr∆∞·ªùng ƒë·ªÉ search
      requiredFields: ["name", "code"], // C√°c tr∆∞·ªùng b·∫Øt bu·ªôc
      uniqueFields: ["code", "email"], // C√°c tr∆∞·ªùng unique
      selectFields: ["id", "name", "code"], // C√°c tr∆∞·ªùng cho dropdown
    });
  }

  // Wrapper methods ƒë·ªÉ gi·ªØ API t∆∞∆°ng th√≠ch
  static getAll = async () => {
    const instance = new YourService();
    return await instance.getAll();
  };

  static getList = async (params) => {
    const instance = new YourService();
    return await instance.getList(params);
  };

  static getById = async (id) => {
    const instance = new YourService();
    return await instance.getById(id);
  };

  static createOrUpdate = async (data, id = null) => {
    const instance = new YourService();
    return await instance.createOrUpdate(data, id);
  };

  static delete = async (id) => {
    const instance = new YourService();
    return await instance.delete(id);
  };

  static deleteMany = async (ids) => {
    const instance = new YourService();
    return await instance.deleteMany(ids);
  };

  static getSelect = async () => {
    const instance = new YourService();
    return await instance.getSelect();
  };

  // ============================================
  // CUSTOM METHODS - Th√™m logic ƒë·∫∑c bi·ªát ·ªü ƒë√¢y
  // ============================================

  static customMethod = async () => {
    const instance = new YourService();
    // Your custom logic here
  };
}

module.exports = YourService;
```

### 2. C·∫•u h√¨nh Options

```javascript
{
  entityName: "cohort",                   // T√™n entity hi·ªÉn th·ªã trong message
  searchFields: ["name", "code"],         // C√°c tr∆∞·ªùng search (d√πng ILIKE)
  requiredFields: ["code", "name"],       // C√°c tr∆∞·ªùng b·∫Øt bu·ªôc khi create/update
  uniqueFields: ["code"],                 // C√°c tr∆∞·ªùng unique c·∫ßn check
  selectFields: ["id", "code", "name"]    // C√°c tr∆∞·ªùng tr·∫£ v·ªÅ cho dropdown/select
}
```

## üìö API Methods

### 1. `getAll(customOrder)`

L·∫•y t·∫•t c·∫£ records.

```javascript
const result = await YourService.getAll();
// ho·∫∑c custom order
const result = await instance.getAll([["name", "ASC"]]);
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "L·∫•y danh s√°ch your_entity th√†nh c√¥ng",
  data: [...]
}
```

---

### 2. `getList({ page, limit, search, customWhere, customOrder })`

L·∫•y danh s√°ch c√≥ ph√¢n trang v√† t√¨m ki·∫øm.

```javascript
const result = await YourService.getList({
  page: 1,
  limit: 10,
  search: "keyword",
  customWhere: { status: "active" }, // Optional
  customOrder: [["name", "ASC"]], // Optional
});
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "L·∫•y danh s√°ch your_entity th√†nh c√¥ng",
  data: {
    list: [...],
    pagination: {
      currentPage: 1,
      totalPages: 5,
      totalItems: 50,
      itemsPerPage: 10
    }
  }
}
```

---

### 3. `getById(id, options)`

L·∫•y record theo ID.

```javascript
const result = await YourService.getById(1);
// ho·∫∑c v·ªõi options
const result = await instance.getById(1, {
  include: [{ model: OtherModel }],
});
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "L·∫•y th√¥ng tin your_entity th√†nh c√¥ng",
  data: {...}
}
```

---

### 4. `createOrUpdate(data, id)`

T·∫°o m·ªõi ho·∫∑c c·∫≠p nh·∫≠t record.

```javascript
// T·∫°o m·ªõi
const result = await YourService.createOrUpdate({
  name: "New Item",
  code: "NEW001",
});

// C·∫≠p nh·∫≠t
const result = await YourService.createOrUpdate(
  {
    name: "Updated Item",
    code: "UPD001",
  },
  1
);
```

**Response (Create):**

```javascript
{
  code: 201,
  success: true,
  message: "T·∫°o your_entity th√†nh c√¥ng",
  data: {...}
}
```

**Response (Update):**

```javascript
{
  code: 200,
  success: true,
  message: "C·∫≠p nh·∫≠t your_entity th√†nh c√¥ng",
  data: {...}
}
```

---

### 5. `delete(id)`

X√≥a record theo ID.

```javascript
const result = await YourService.delete(1);
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "X√≥a your_entity th√†nh c√¥ng",
  data: { id: 1 }
}
```

---

### 6. `deleteMany(ids)`

X√≥a nhi·ªÅu records theo danh s√°ch IDs.

```javascript
const result = await YourService.deleteMany([1, 2, 3]);
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "X√≥a th√†nh c√¥ng 3 your_entity",
  data: {
    deletedIds: [1, 2, 3],
    deletedCount: 3
  }
}
```

---

### 7. `getSelect(customOrder, customWhere)`

L·∫•y danh s√°ch cho dropdown/select.

```javascript
const result = await YourService.getSelect();
// ho·∫∑c v·ªõi custom
const result = await instance.getSelect([["name", "ASC"]], {
  status: "active",
});
```

**Response:**

```javascript
{
  code: 200,
  success: true,
  message: "L·∫•y danh s√°ch your_entity cho select th√†nh c√¥ng",
  data: [
    { id: 1, code: "C001", name: "Item 1" },
    { id: 2, code: "C002", name: "Item 2" }
  ]
}
```

---

### 8. `count(whereCondition)`

ƒê·∫øm s·ªë l∆∞·ª£ng records.

```javascript
const instance = new YourService();
const count = await instance.count({ status: "active" });
```

---

### 9. `exists(whereCondition)`

Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa record.

```javascript
const instance = new YourService();
const isExist = await instance.exists({ code: "C001" });
```

## üé® Override Methods

B·∫°n c√≥ th·ªÉ override b·∫•t k·ª≥ method n√†o ƒë·ªÉ customize logic:

```javascript
class YourService extends BaseService {
  constructor() {
    super(YourModel, {...});
  }

  // Override getAll ƒë·ªÉ th√™m logic ri√™ng
  async getAll(customOrder = null) {
    // Custom logic before
    console.log('Getting all records...');

    // Call parent method
    const result = await super.getAll(customOrder);

    // Custom logic after
    console.log('Got', result.data.length, 'records');

    return result;
  }

  // Override validation
  validateData(data) {
    // Custom validation
    if (data.start_year > data.end_year) {
      return {
        code: 400,
        success: false,
        message: "NƒÉm b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n nƒÉm k·∫øt th√∫c",
        data: null
      };
    }

    // Call parent validation
    return super.validateData(data);
  }
}
```

## üìù V√≠ d·ª• th·ª±c t·∫ø: CohortService

```javascript
const BaseService = require("./base.service");
const db = require("../models");
const Cohort = db.Cohort;

class CohortService extends BaseService {
  constructor() {
    super(Cohort, {
      entityName: "cohort",
      searchFields: ["name", "code"],
      requiredFields: ["code", "name", "start_year"],
      uniqueFields: ["code"],
      selectFields: ["id", "code", "name"],
    });
  }

  // Wrapper methods
  static getAllCohorts = async () => {
    const instance = new CohortService();
    return await instance.getAll();
  };

  static getListCohorts = async (params) => {
    const instance = new CohortService();
    return await instance.getList(params);
  };

  static getCohortById = async (id) => {
    const instance = new CohortService();
    return await instance.getById(id);
  };

  static createOrUpdateCohort = async (data, id = null) => {
    const instance = new CohortService();
    return await instance.createOrUpdate(data, id);
  };

  static deleteCohort = async (id) => {
    const instance = new CohortService();
    return await instance.delete(id);
  };

  static deleteManyCohorts = async (ids) => {
    const instance = new CohortService();
    return await instance.deleteMany(ids);
  };

  static getSelectCohorts = async () => {
    const instance = new CohortService();
    return await instance.getSelect();
  };

  // Custom method
  static getCohortsByYear = async (year) => {
    const instance = new CohortService();
    try {
      const cohorts = await instance.model.findAll({
        where: { start_year: year },
        order: [["name", "ASC"]],
      });

      return {
        code: 200,
        success: true,
        message: `L·∫•y danh s√°ch cohort nƒÉm ${year} th√†nh c√¥ng`,
        data: cohorts,
      };
    } catch (error) {
      throw new Error(`L·ªói khi l·∫•y cohort theo nƒÉm: ${error.message}`);
    }
  };
}

module.exports = CohortService;
```

## üîÑ Migration t·ª´ Service c≈©

### Before (271 d√≤ng):

```javascript
class CohortService {
  static getAllCohorts = async () => {
    try {
      const cohorts = await Cohort.findAll({
        order: [["created_at", "DESC"]],
      });
      return {
        code: 200,
        success: true,
        message: "L·∫•y danh s√°ch cohort th√†nh c√¥ng",
        data: cohorts,
      };
    } catch (error) {
      throw new Error(`L·ªói khi l·∫•y danh s√°ch cohort: ${error.message}`);
    }
  };
  // ... 250+ d√≤ng n·ªØa
}
```

### After (90 d√≤ng):

```javascript
class CohortService extends BaseService {
  constructor() {
    super(Cohort, {
      entityName: "cohort",
      searchFields: ["name", "code"],
      requiredFields: ["code", "name", "start_year"],
      uniqueFields: ["code"],
      selectFields: ["id", "code", "name"],
    });
  }

  static getAllCohorts = async () => {
    const instance = new CohortService();
    return await instance.getAll();
  };
  // Ch·ªâ c·∫ßn wrapper methods, logic ƒë√£ c√≥ s·∫µn!
}
```

## üéØ Best Practices

1. **Lu√¥n t·∫°o instance m·ªõi** trong static methods ƒë·ªÉ tr√°nh conflicts
2. **Override methods** khi c·∫ßn logic ƒë·∫∑c bi·ªát
3. **S·ª≠ d·ª•ng customWhere v√† customOrder** thay v√¨ vi·∫øt l·∫°i to√†n b·ªô method
4. **Validate ·ªü Service layer**, kh√¥ng ph·ª• thu·ªôc v√†o database constraints
5. **Throw Error** ƒë·ªÉ Controller x·ª≠ l√Ω v√† format response

## üõ†Ô∏è Troubleshooting

### L·ªói: "Kh√¥ng t√¨m th·∫•y..."

- Ki·ªÉm tra `id` c√≥ ƒë√∫ng kh√¥ng
- Ki·ªÉm tra record c√≥ t·ªìn t·∫°i trong database kh√¥ng

### L·ªói: "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá"

- Ki·ªÉm tra `requiredFields` trong constructor
- ƒê·∫£m b·∫£o data truy·ªÅn v√†o ƒë√∫ng format

### L·ªói: "... ƒë√£ t·ªìn t·∫°i"

- Ki·ªÉm tra `uniqueFields` trong constructor
- ƒê·∫£m b·∫£o gi√° tr·ªã unique fields kh√¥ng b·ªã tr√πng

## üì¶ Structure

```
src/services/
‚îú‚îÄ‚îÄ base.service.js       # Base class ch·ª©a logic CRUD chung
‚îú‚îÄ‚îÄ cohort.service.js     # Service k·∫ø th·ª´a BaseService
‚îú‚îÄ‚îÄ student.service.js    # Service k·∫ø th·ª´a BaseService
‚îú‚îÄ‚îÄ teacher.service.js    # Service k·∫ø th·ª´a BaseService
‚îî‚îÄ‚îÄ README.md            # File n√†y
```

## üîÆ T∆∞∆°ng lai

- [ ] Th√™m soft delete support
- [ ] Th√™m audit log t·ª± ƒë·ªông
- [ ] Th√™m cache layer
- [ ] Th√™m transaction support
- [ ] Th√™m bulk operations

---

**Created by:** Copilot  
**Date:** 28/10/2025  
**Version:** 1.0.0
